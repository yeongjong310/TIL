# ch38. 브라우저의 렌더링 과정
HTTP, response

## 1. 리소스 요청
브라우저는 사용자에게 보여줄 리소스가 필요하다.
리소스는 서버에 존재하기 때문에 서버의 주소인 IP address를 알아내야하며,
이때 사용자가 입력한 도메인이 사용된다.
브라우저는 도메인 네임시스템(DNS)에 도메인과 일치하는 IP address를 요청하며,
일치하는 도메인이 있다면 IP주소를 응답받아, 서버에 리소스를 요청한다.

## 2. 요청 정보 준비 및 전달
### 2.1. [TCP / IP 4 layer](https://github.com/yeongjong310/network/blob/main/tcp_ip_layer.md)
TCP /IP 4 layer에 의해 요청에 대한 정보가 패킷단위로 변화되고, 네트워크상에서 주고받을 수 있도록 이진화되어 바이트 형태로 정보가 전달된다.

> 참고: HTTP3는 빠른 전송을 위해 TCP 방식이 아닌 UDP 방식을 택했다고 한다.

### 2.2. [HTTP](https://github.com/yeongjong310/network/blob/main/http.md)
응용프로그램 계층의 통신 규약이다.
서버와 브라우저가 데이터를 주고 받을 때 문서의 양식과, 통신방법을 규정해서 원활하게 통신하기 위해 고안되었다.

## 3. 응답
일반적으로 루트 요청의 경우 브라우저는 바이트 구성된 index.html을 응답 받는다. 이 때 브라우저가 가장먼저 하는 일은 바이트를 올바르게 해석하기 위해 응답헤더에 메타정보를 읽기 시작한다. 메타정보에는 인코딩 방식이 정해져있고, 이를 참고해서 문자열로 변환한다.

## 4. HTML 파싱
다음은 문자열(html markup)을 해석해서 화면에 렌더링해야 한다.
브라우저는 효율적으로 렌더링하기 위해 이 문자열을 해석해서 DOM트리를 만들어 낸다.

### 4.1. 토크나이징
문자열을 읽어가며 문자로서 최소한의 의미를 가지를 토큰으로 변환한다.

### 4.2. 노드
토큰들은 DOM을 구성하는 단위인 노드로 변환된다. 노드는 하나의 객체이며, 토큰의 내용에 따라 문서 노드, 요소 노드, 어트리뷰트 노드, 텍스트 노드가 생성된다. 노드는 이후 DOM을 구성하는 기본 요소가 된다.

### 4.3. DOM트리 생성
HTML은 부모 형제간의 관계를 가지는 중첩구조로 이루어져 있다. 이를 표현할 수 있는 트리 자료구조로 노드를 구성한다. 이렇게 생성된 트리를 DOM(Document Object Model)이라고 부르며, DOM Api를 통해 DOM을 조작할 수 있다.

### 5. CSS 파싱
HTML과 동일한 과정으로 (바이트 -> 문자 -> 토큰 -> 노드) -> CSSOM 이 생성된다. DOM이 구조에 대한 정보를 가지고 있다면, CSSOM은 스타일에 대한 정보를 담고 있다.

### 6. 렌더 트리 생성
DOM에는 head 태그 CSSOM에는 display none 프로퍼티와 같은 렌더링에 필요없는 노드도 포함하고 있다. 따라서 브라우저는 최종적으로 DOM과 CSSOM을 참고하여 렌러딩될 노드들만 취합하여 렌더 트리를 생성한다.

브라우저는 렌더 트리를 기반으로 화면에 표시될 컨텐츠의 위치를 계산(레이아웃 수치)하고, 이 수치를 기반으로 화면에 그리는 작업인 페인트 작업을 거쳐 최종적으로 렌더링 과정이 마무리 된다.

## 7. **리플로우(핵심)** 리페인트
레이아웃이 변경되는 작업을 수행하면(width 값 변경 등), 변경된 레이아웃을 기준으로 자식노드들은 거의 대부분 리플로우가 일어난다. 고비용이기 때문에, 리플로우가 일어나지 않는 방향으로 설계해야 한다.

## 8. 블로킹

DOM 트리는 script 태그를 만나게 되면, 병렬적으로 파싱하는 것이 아니라 DOM 파싱을 즉시 중단하고, JS 파싱을 진행한다. DOM 파싱이 중단되면, 아직 생성되지 않은 DOM 요소를 참조하는 등의 오류가 발생할 수 있기 때문에 블로킹을 고려하여 요청 순서를 정하는 것은 매우 중요하다.


### 8.1 async / defer 어트리뷰트
script 태그를 만나면 DOM 파싱이 즉시 중단된다. 이는 효율적인 파싱은 아니기 때문에 이에 대응할 수 있는 두 가지 어트리뷰트가 추가되었다.

1. async
외부에 리소스를 요청할 때 파일의 로드가 비동기적으로 진행된다. 즉 리소스 요청 태그를 만났을 때 DOM의 파싱을 즉시 중단하는 것이 아니라, 리소스에 대한 응답을 받으면 DOM 파싱을 중단하고, Js를 파싱한다.

2. defer
파일 로드를 비동기적으로 진행한다. 다만, 파싱은 DOM 생성이 완료된 직후 DOMContentLoaded 이벤트가 발생하면 Js를 파싱한다.